---
description: TanStack Start with SolidJS - overview and project structure
globs: ["src/**/*.tsx", "src/**/*.ts", "vite.config.ts"]
alwaysApply: true
---

# TanStack Start with SolidJS

> Primary Reference: https://tanstack.com/start/latest/docs/framework/solid

## Documentation Structure

This project uses TanStack Start (full-stack framework) with TanStack Router.
Documentation is split across multiple files for focused reference:

| File | When to Reference |
|------|-------------------|
| `tanstack-router.mdc` | Creating page routes, navigation, path/search params |
| `tanstack-server-functions.mdc` | Using `createServerFn` for server-side logic |
| `tanstack-server-routes.mdc` | Creating API endpoints (⚠️ NOT createAPIFileRoute) |
| `tanstack-data-loading.mdc` | Route loaders, beforeLoad, preloading |

## ⚠️ Critical Corrections

### `createAPIFileRoute` DOES NOT EXIST

This function is **not real**. Server routes use `createFileRoute` with a `server` property:

```typescript
// ❌ WRONG - this import/function does not exist
import { createAPIFileRoute } from "@tanstack/solid-start/api";

// ✅ CORRECT - use createFileRoute with server property
import { createFileRoute, json } from "@tanstack/solid-router";

export const Route = createFileRoute("/api/data")({
  server: {
    handler: {
      GET: async ({ request, params, context }) => {
        return json({ data: "value" });
      },
    },
  },
});
```

See `tanstack-server-routes.mdc` for complete documentation.

## Project Structure

```
src/
├── components/          # reusable UI components
├── lib/
│   ├── auth.ts          # auth configuration
│   ├── auth-client.ts   # client auth hooks
│   ├── db/              # database schema and helpers
│   └── server/          # server functions organized by feature
│       ├── auth.ts
│       ├── context.ts   # getCloudflareContext helpers
│       └── tracks.ts
├── routes/              # file-based routing
│   ├── __root.tsx       # root layout (createRootRouteWithContext)
│   ├── index.tsx        # home page (/)
│   ├── api/             # server routes
│   │   ├── upload.ts    # /api/upload
│   │   └── files/
│   │       └── $.ts     # /api/files/* (wildcard)
│   ├── auth/
│   │   ├── login.tsx    # /auth/login
│   │   └── signup.tsx   # /auth/signup
│   └── track/
│       └── $trackId.tsx # /track/:trackId
├── router.tsx           # router configuration
├── routeTree.gen.ts     # auto-generated route tree (DO NOT EDIT)
└── styles.css           # global styles
```

## Core Imports

```typescript
// page routes
import { createFileRoute, Link, Outlet } from "@tanstack/solid-router";
import { createRootRouteWithContext } from "@tanstack/solid-router";

// server functions
import { createServerFn } from "@tanstack/solid-start/server";

// cloudflare integration
import { getCloudflareContext } from "@tanstack/solid-start/cloudflare";

// navigation
import { redirect, notFound } from "@tanstack/solid-router";

// response helpers (for server routes)
import { json } from "@tanstack/solid-router";
```

## Quick Reference

### Page Route

```typescript
// src/routes/about.tsx
import { createFileRoute } from "@tanstack/solid-router";

export const Route = createFileRoute("/about")({
  head: () => ({
    meta: [{ title: "About - My App" }],
  }),
  component: AboutPage,
});

function AboutPage() {
  return <div>About us</div>;
}
```

### Route with Loader

```typescript
// src/routes/index.tsx
import { createFileRoute } from "@tanstack/solid-router";
import { fetchTracks } from "~/lib/server/tracks";

export const Route = createFileRoute("/")({
  loader: async () => {
    return fetchTracks({ data: { limit: 20 } });
  },
  component: HomePage,
});

function HomePage() {
  const tracks = Route.useLoaderData();
  return <For each={tracks()}>{(t) => <div>{t.title}</div>}</For>;
}
```

### Protected Route

```typescript
// src/routes/upload.tsx
import { createFileRoute, redirect } from "@tanstack/solid-router";
import { getSession } from "~/lib/server/auth";

export const Route = createFileRoute("/upload")({
  beforeLoad: async () => {
    const session = await getSession();
    if (!session?.user) {
      throw redirect({ to: "/auth/login" });
    }
    return { session };
  },
  component: UploadPage,
});

function UploadPage() {
  const { session } = Route.useRouteContext();
  // session is guaranteed to exist
}
```

### Server Function

```typescript
// src/lib/server/tracks.ts
import { createServerFn } from "@tanstack/solid-start/server";

export const fetchTracks = createServerFn({ method: "GET" })
  .validator((data?: { limit?: number }) => data ?? {})
  .handler(async ({ data }) => {
    const db = getDrizzleDB();
    return db.select().from(tracks).limit(data.limit ?? 20);
  });
```

### Server Route (API Endpoint)

```typescript
// src/routes/api/health.ts
import { createFileRoute, json } from "@tanstack/solid-router";

export const Route = createFileRoute("/api/health")({
  server: {
    handler: {
      GET: async () => {
        return json({ status: "ok" });
      },
    },
  },
});
```

## SolidJS Patterns

Remember: TanStack Router with SolidJS uses **accessors** (functions):

```typescript
function MyComponent() {
  // these return accessors, must call to get value
  const params = Route.useParams();
  const search = Route.useSearch();
  const data = Route.useLoaderData();
  
  // access values
  console.log(params().trackId);  // ✅ call the accessor
  console.log(params.trackId);     // ❌ undefined (it's a function)
  
  return <div>{data()?.title}</div>;
}
```

## Execution Model

> Reference: https://tanstack.com/start/latest/docs/framework/solid/guide/execution-model

- **SSR**: `loader` and `beforeLoad` run on server during initial request
- **Client Navigation**: `loader` and `beforeLoad` run on client
- **Server Functions**: Always run on server, serialized over network
- **Components**: Run on both server (SSR) and client (hydration/SPA)

## Key Patterns

1. **Export `Route`** - Required export name for route tree generation
2. **Path must match file** - `createFileRoute("/path")` must match file location
3. **Use accessors** - All hooks return functions in SolidJS
4. **Server functions for mutations** - Use `createServerFn` for database operations
5. **Server routes for raw HTTP** - Use `createFileRoute` + `server` property for APIs
6. **Organize server logic** - Put server functions in `src/lib/server/`
