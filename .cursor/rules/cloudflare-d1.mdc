---
description: Cloudflare D1 database patterns for TanStack Start
globs: ["src/lib/db*.ts", "src/server/**/*.ts", "migrations/**/*.sql", "wrangler.jsonc"]
---

# Cloudflare D1 with TanStack Start

## IMPORTANT: Database Access Patterns

**CRITICAL**: This project uses TWO different database access patterns:

1. **Drizzle ORM** - For ALL database access EXCEPT Better Auth
   - Use `getDrizzleDB()` from `src/lib/server/context.ts`
   - All DB methods in `src/lib/db/index.ts` use Drizzle
   - All methods include authorization checks via `AuthContext`

2. **Kysely-D1** - ONLY for Better Auth
   - Better Auth uses kysely-d1 internally (configured in `src/lib/auth.ts`)
   - Do NOT use Drizzle for Better Auth tables (user, session, account, verification)

## Wrangler Configuration

Add D1 binding in `wrangler.jsonc`:

```jsonc
{
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "laptou-sound-db",
      "database_id": "<your-database-id>"
    }
  ]
}
```

## Creating D1 Database

```bash
# create database
bun wrangler d1 create laptou-sound-db

# run migrations locally
bun wrangler d1 migrations apply laptou-sound-db --local

# run migrations in production
bun wrangler d1 migrations apply laptou-sound-db --remote
```

## Migration Files

Place migrations in `migrations/` directory with naming convention:
`NNNN_description.sql` (e.g., `0001_initial_schema.sql`)

## Drizzle Schema

Schema is defined in `src/lib/db/schema.ts` using Drizzle ORM:

```typescript
import { sqliteTable, text, integer, index } from "drizzle-orm/sqlite-core";

export const track = sqliteTable("track", {
  id: text("id").primaryKey(),
  uploaderId: text("uploader_id").notNull(),
  title: text("title").notNull(),
  // ...
});
```

## Accessing D1 with Drizzle

**Always use Drizzle for non-auth database access:**

```typescript
import { createServerFn } from "@tanstack/solid-start/server";
import { getDrizzleDB } from "~/lib/server/context";
import { getSession } from "~/lib/server/auth";
import { getRecentTracks } from "~/lib/db";

const getTracks = createServerFn({ method: "GET" }).handler(async () => {
  const db = getDrizzleDB();
  // public read - no auth context needed
  return getRecentTracks(db, 20, 0);
});
```

## Authorization Pattern

All DB methods that modify data require an `AuthContext`:

```typescript
import { getDrizzleDB } from "~/lib/server/context";
import { getSession } from "~/lib/server/auth";
import { createTrack } from "~/lib/db";

const createNewTrack = createServerFn({ method: "POST" })
  .handler(async ({ data }) => {
    const session = await getSession();
    const db = getDrizzleDB();
    
    // create auth context for authorization checks
    const context = session
      ? { userId: session.user.id, role: session.role }
      : null;
    
    return createTrack(
      db,
      session.user.id,
      data.title,
      data.description,
      context // authorization context required
    );
  });
```

## DB Method Signatures

All DB methods follow this pattern:

- **Read methods** (public): No auth context required
  - `getRecentTracks(db, limit, offset)`
  - `getTrackById(db, trackId)`
  - `getTrackVersions(db, trackId)`

- **Write methods**: Require auth context
  - `createTrack(db, uploaderId, title, description, context)`
  - `deleteTrack(db, trackId, context)`
  - `createComment(db, trackId, userId, content, timestampSeconds, context)`

- **System methods**: No auth context (called by workers)
  - `updateTrackVersionStatus(db, versionId, status, playbackKey, waveformKey, duration)`

## Key Patterns

1. **NEVER use raw D1 queries** - Always use Drizzle ORM methods from `src/lib/db/index.ts`
2. **NEVER use Drizzle for Better Auth** - Better Auth uses kysely-d1 internally
3. Always pass `AuthContext` to write operations for authorization checks
4. Use `getDrizzleDB()` from context, not `getDB()` (which is raw D1 for Better Auth only)
5. All DB methods include built-in authorization checks
6. SQLite uses INTEGER for booleans (0/1)
7. Use TEXT for dates in ISO format
8. Create indexes for frequently queried columns
9. Use `--local` flag for development, `--remote` for production
